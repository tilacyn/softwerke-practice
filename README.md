# softwerke-practice
Here are the materials on the Developing OSGi Application Project, Feb-Mar 2019, SoftWerke

--

Author: Maksim Kryuchkov


## Project

Состоит из 5-ти этапов. Первый этап ознакомительный

### Stage 2

Лежит в папке stage2. Собранные бандлы лежат в папке bundles.

Проект состоит из трех модулей: org.tilacyn.hello, org.tilacyn.hello.client и org.tilacyn.hello.main

Первые два модуля - это OSGi модули, hello - это сервис, client - клиент. Модуль Main не является OSGi модулем, он просто запускает приложение используя Apache Felix. Через Gogo тоже пробовал собирать, все работает.

Корень проекта: stage2/service

Команда для сборки:

```bash
mvn install
```

Команда для тестирования приложения через Main:

```bash
cd org.tilacyn.hello.main
mvn exec:java
```

### Stage 3

Задание сделано, лежит в папке stage3.


Команда для сборки:

```bash
mvn install
```

Команда для тестирования приложения через Main:

```bash
cd org.tilacyn.hello.main
mvn exec:java
```

### Stage 4

Лежит в папке stage4. Сборка - maven install. Готовый бандл в stage4/bundles

### Stage 5

Задание лежит в папке `stage5`, собранные бандлы в `stage5/bundles`.

#### Как устроен проект?

Было сделано два интерфейса - один `Wget`, другой - `StatisticsProvider`

`Wget` имеет один метод - `getNewsTitle`, от которого ожидается возврат списка заголовков.
У `Wget` есть две имплементации - `LentaWget` и `RSSWget`, каждая из которых сначала качает API новостных порталов, а затем парсит его package-private парсером. И `LentaWget` и `RSSWget` являются компонентами, реализующими интерфейс `Wget`, и у каждой из них есть свойство `@Property(name = "source", value = "(lenta|rss)")` (value равно соответствующей строке)

Есть главный класс `TitleAnalyzer`, который имплементит `StatisticsProvider` и который является потребителем сервисов `Wget`. Соответственно у него есть поля типа `Wget` с аннотацией `Reference`, которые он использует, чтобы получиться список заголовков и посчитать 10 самых встречающихся слов. `TitleAnalyzer` в свою очередь с помощью аннотаций `@Properties` во время регистрации создает новую консольную команду `news:stats`.

#### Проблема

У меня возникла проблема. На данный момент приложение не обладает той функциональностью, которая требуется. Дело в том, только в рантайме наше приложение узнает о том, какой источник хочет пользователь. Отсюда напрашивается вывод, что параметр target у Reference у поля типа Wget должен быть равен какой-то переменной, то есть

```java
@Reference(target = "(source=%runtime_variable%)")
Wget wget;
```
Я не смог найти, как это сделать, хотя видел указания, что так можно, в интернете.

Поэтому я решил использовать два поля типа `Wget`, одно специально для ленты, другое - для `RSS`. Мне кажется это подход концептуально неправильный, потому что класс `TitleAnalyzer` не должен заботиться о том, какие сервисы бывают зарегистрированы. Если бы получилось сделать `target` зависимым от параметра функции `stats`, то пользователь напрямую бы общался в SCR, и это был бы правильный подход. Но помимо неправильного подхода получается ограничение функциональности, которое можно устранить, но я не знаю как. А именно: Сейчас компонента `TitleAnalyzer` не активируется до тех пор, пока не будут запущены бандлы и с лентой, и с RSS. Это уже совсем плохо. Я попробовал поменять параметр `Reference.policy` со `static` на `dynamic`. Вроде должно работать, но не работает..

#### Решение проблемы

Согласно подсказке я изменил библиотеку аннотаций на `org.osgi.service.component.annotations` и использовал `List<Wget> sources` в качестве контейнера для сервисов. Использование `java.util.Map` выдавало ошибку по время рантайма, которая никак не влияла на исполнение программы, просто SCR печатал в консоль, что вместо `Map` следует использовать `Collection` или `List`.

Теперь динамизм работает, и провайдеры новостных заголовков могут подключаться и отключаться по время исполнения программы.

Проблема с подсчетом самых частых слов была очень глупой: вместо 10 самых частых слов в консоль печаталось 10 самых редких (компаратор работал в другую сторону). Я еще во время предыдущей отправки решения обратил на это внимание, но почему-то не исправил.
